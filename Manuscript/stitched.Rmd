---
output:
  word_document:
    fig_caption: true
  pdf_document:
    fig_caption: true
    latex_engine: xelatex
    keep_tex: yes
  html_document:
    toc: false
header-includes:
   - \usepackage{booktabs}
   - \usepackage[final]{changes}
   - \usepackage[font={small},labelfont=bf,labelsep=colon]{caption}
   - \linespread{1.5}
   - \usepackage[compact]{titlesec}
   - \usepackage{enumitem}
   - \usepackage{tikz}
   - \def\checkmark{\tikz\fill[scale=0.4](0,.35) -- (.25,0) -- (1,.7) -- (.25,.15) -- cycle;}
   - \setlist{nolistsep}
   - \setremarkmarkup{(#2)}
bibliography: references.bib
csl: national-science-foundation-grant-proposals.csl
fontsize: 11pt
mainfont: Georgia
geometry: margin=1.0in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set( cache=TRUE )
```

\pagenumbering{gobble}

\vspace{2 cm}

\begin{centering}

\LARGE

{\bf The ANTs Longitudinal Cortical Thickness Pipeline}

\vspace{0.5 cm}

\large
Nicholas J. Tustison$^{1,2}$,
Andrew J. Holbrook$^3$,
Brian B. Avants$^4$,
Jared M. Roberts$^2$,
Philip A. Cook$^5$,
James R. Stone$^1$,
Daniel L. Gillen$^3$, and
Michael A. Yassa$^2$
for the Alzheimer's Disease Neuroimaging Initiative*


\vspace{0.5 cm}

\small

$^1$Department of Radiology and Medical Imaging, University of Virginia, Charlottesville, VA

$^2$Department of Neurobiology and Behavior, University of California, Irvine, Irvine, CA

$^3$Department of Statistics, University of California, Irvine, Irvine, CA

$^4$Biogen, Cambridge, MA

$^5$Department of Radiology, University of Pennsylvania, Philadelphia, PA

\end{centering}


\vspace{4 cm}

\small

Corresponding author: \
Nicholas J. Tustison \
211 Qureshey Research Lab \
Irvine, CA  92697-3800 \
540-383-2719 \
ntustison@virginia.edu \

\noindent\rule{4cm}{0.4pt}

\footnotesize
*Data used in preparation of this article were obtained from the Alzheimer’s Disease Neuroimaging Initiative (ADNI) database (adni.loni.usc.edu). As such, the investigators within the ADNI contributed to the design and implementation of ADNI and/or provided data but did not participate in analysis or writing of this report. A complete listing of ADNI investigators can be found at: http://adni.loni.usc.edu/wp-content/uploads/how_to_apply/ADNI_Acknowledgement_List.pdf

\newpage

\normalsize

# Abstract

Large-scale longitudinal studies of developmental progression or disease in the human brain
have motivated the acquisition of large neuroimaging data sets and the
concomitant development of robust methodological and statistical tools
for insight into potential neurostructural changes.  Longitudinal strategies
for acquisition and processing have potentially significant benefits including
the reduction of the inter-subject variability of corresponding cross-sectional
studies.  In this work, we introduce the open-source Advanced
Normalization Tools (ANTs) cortical thickness longitudinal processing pipeline
and its application on the Alzheimer's Disease Neuroimaging Initiative 1 data set
consisting of over 600 subjects with multiple time points from baseline to 36 months.
We show that single-subject template construction and native subject-space processing
localizes data transformations and reduces interpolation artifacts, respectively,
and is the preferred strategy for minimizing within-subject variability and maximizing
between-subject variability.  Furthermore, we demonstrate that these criteria
lead to greater diagnostic predictive accuracy over other possible processing strategies.
In the spirit of open-science, the ANTs software (including the longitudinal cortical
thickness processing framework), regional data tables, and processing scripts are
publicly available.

\clearpage

<!--

You can add internal comments which will not be reproduced using html comment delimiters.

-->

# Introduction

Quantification of brain morphology is invaluable for studying a wide range of
neurological conditions with structural correlates (e.g.,
Alzheimer's disease and frontotemporal dementia [@du2007;@dickerson2009],
Parkinson's disease [@jubault2011],
Williams syndrome [@thompson2005],
multiple sclerosis [@ramasamy2009],
autism [@chung2005,@hardan2006],
migraines [@dasilva2007],
chronic smoking [@kuhn2010],
alcoholism [@fortier2011],
cocaine addiction [@makris2008],
schizophrenia [@nesvag2008],
bipolar disorder [@lyoo2006],
autism [@chung2005,@hardan2006],
marijuana use in adolescents [@Jacobus:2015aa],
Tourette syndrome in children [@sowell2008],
scoliosis in female adolescents [@wang2012],
heart failure [@Kumar:2015aa],
early-onset blindness [@jiang2009],
chronic pancreatitis [@frokjaer2012],
obsessive-compulsive disorder [@shin2007],
ADHD [@almeida-montes2012],
obesity [@raji2010],
heritable [@peterson2009] and elderly [@ballmaier2004] depression,
age [@kochunov2011],
gender [@luders2006a],
untreated male-to-female transsexuality [@luders2012],
handedness
[@luders2006,amunts2007],
intelligence [@shaw2006],
athletic ability [@wei2011],
meditative practices [@lazar2005],
musical ability [@bermudez2009;@foster2010],
musical instrument playing [@Hudziak:2014aa],
tendency toward criminality [@raine2011],
childhood sexual abuse in adult females [@heim2013],
and Tetris-playing ability in female adolescents [@haier2009]).
Essential for thickness quantification are the
many computational techniques which have been developed
to provide accurate measurements of the cerebral cortex.
These include various mesh-based
(e.g., [@macdonald2000;@magnotta1999;@kim2005]) and
volumetric techniques
(e.g., [@zeng1999;@jones2000;@das2009;@clement-vachet2011]).
Of noted significance, and representing the former,
is the well-known and highly utilized FreeSurfer
software package [@dale1999;@fischl1999;@fischl2000;@fischl2002;@fischl2004].

In inferring developmental processes, many of these studies employ
cross-sectional population sampling strategies despite the potential for
confounding effects [@Kraemer:2000aa].  Large-scale longitudinal studies,
such as the Alzheimer's Disease Neuroimaging Initiative (ADNI) [@Weiner2012],
mitigate some of the relevant statistical issues.  Similarly, much
research has been devoted to exploring methodologies for exploiting such studies
and avoiding various forms of processing bias [@Reuter:2011aa].
Examples of the former include 4-D longitudinal segmentation [@Xue:2006aa;@Wang:2013ac]
and unbiased template creation [@Avants:2010aa;@Reuter:2012aa].
An example of the latter includes the bias associated with image spatial normalization to a
designated coordinate system [@Yushkevich:2010aa].  Briefly,
interpolation-induced artifacts which occur during spatial normalization can
artificially inflate effect size.

In [@Tustison:2014ab], we introduced the Advanced Normalization Tools (ANTs) cortical
thickness framework which leverages various pre-processing, registration, segmentation,
and other image analysis tools that members of the ANTs and Insight Toolkit (ITK)
communities have developed over the years and disseminated as open-source.[^1]  
This proposed ANTs-based pipeline has since been directed at a variety of neuroimaging
topics including mild cognitive impairment and depression [@Fujishima:2014aa],
short term memory in mild cognitive impairment [@Das:2016aa], and aphasia [@Olm:2016aa].
In this work, we introduce the ANTs longitudinal cortical thickness pipeline and
use it to process the ADNI1 data set.  We demonstrate that certain longitudinal
processing choices have significant impact on measurement quality in terms of
 within-subject and between subject variances which, in turn, heavily impacts
the clinical interpretability of results.  

[^1]: https://github.com/stnava/ANTs

# Methods and materials

## Longitudinal ADNI imaging data

![Demographic breakdown of the number of ADNI subjects by diagnosis i.e., normal,
mild cognitive impairment (MCI), late mild cognitive impairment (LMCI),
and Alzheimer's disease (AD).  Within each panel we plot the number of subjects
(by gender) per visit---baseline ("bl") and $n$ months ("m$n$").](../Figures/demoPlot.png)

The strict protocol design, large-scale recruitment, and public availability of
the Alzheimer’s Disease Neuroimaging Initiative (ADNI) makes it
an ideal data set for evaluating the ANTs longitudinal cortical thickness pipeline.
An MP-RAGE [@Mugler:1990aa] sequence for 1.5 and 3.0 T was used to collect the data
at the scan sites.  Specific acquisition parameters for 1.5 T and 3.0 T magnets
are given in Table 1 of [@Jack:2008aa].  Originally, collection goals were
200 elderly cognitively normal subjects collected at 0, 6, 12, 24, and 36 months;
400 MCI subjects at risk for AD conversion at 0, 6, 12, 18, 24, and 36 months; and
200 AD subjects at 0, 6, 12, and 24 months.  

![Age vs. Mini-mental examination (MMSE) scores for the ADNI subjects
by diagnosis.  ](../Figures/demoPlot2.png)

We downloaded the ADNI1 data in May of 2014.  The data was first processed using
the ANTs cross-sectional cortical thickness pipeline [@Tustison:2014ab]
(4399 total images).  Data was then processed using the ANTs longitudinal
stream (described in the next section) only including data for which at least two
time points were available.  In the final set of csv files we only included
time points for which clinical scores (e.g., MMSE) were available.  In total,
we included 186 elderly cognitive normals, 178 MCI subjects, 128 LMCI subjects,
and 123 AD subjects.  A further breakdown of demographic information is given
in Figure X.  Similarly, in Figure X, we show the 2-D distribution of age vs. mini-mental
examination (MMSE) scores taken at the month 12 visit across diagnoses for the subjects
analyzed.



## ANTs Cortical thickness estimation

### Cross-sectional processing

A thorough discussion of the ANTs cross-sectional thickness estimation framework
was previously discussed in [@Tustison:2014ab].  Briefly, given a T1-weighted brain MR image,
processing comprises the following five major steps (cf Figure X of [@Tustison:2014ab]):

* N4 bias correction [@Tustison:2010ac],
* brain extraction [@avants2010a],
* Atropos six-tissue segmentation [@Avants:2011aa], and
* cortical thickness estimation [@das2009].

ROI-based quantification is achieved through the use of the joint label fusion
approach of [@Wang:2013ab] and the use of the MindBoggle-101 data labeled using
the Desikan–Killiany–Tourville (DKT) protocol [@Klein:2012aa] consisting of 31
labels per hemisphere (cf Table 1).
This pipeline has since been enhanced by the implementation [@Tustison:2016aa] of a patch-based
denoising algorithm [@Manjon:2010aa] as an optional preprocessing step and multi-modal
integration capabilities.  

\input{dktRegions.tex}

For evaluation, regional thickness statistics were calculated based on the DKT
parcellation scheme.  Test-retest error measurements were presented
from a cohort of 20 atlases taken from the OASIS data set which had been manually
labeled [@Klein:2012aa] and compared with the
analogous FreeSurfer thickness values.    Further evaluation employed a training/prediction
paradigm whereby DKT regional cortical thickness values generated from 1205
images taken from four publicly available data sets (i.e., IXI [@ixi], MMRR [@landman2011],
NKI [@nki], and OASIS [@oasis]) were used to predict age and gender using linear and
random forest models.  Although repeatability was comparable between the two packages,
predictive accuracy was improved with ANTs versus FreeSurfer.

The resulting regional statistics (including cortical thickness, surface area [@Lehmann:2012aa],
volumes, and Jacobian determinant values) are available online.[^2]  These include the corresponding
FreeSurfer measurements which are also publicly available for research
studies (e.g., [@Hasan:2016aa]).
Since publication this pipeline has been used in a number of cross-sectional studies
(e.g., [@Price:2015aa;@Wisse:2015aa;@Betancourt:2015aa]).

[^2]: https://github.com/ntustison/KapowskiChronicles


<!--
A further extension is the potential inclusion of additional modalities
(e.g. T2-weighted).  
-->

### Unbiased longitudinal processing

![Diagrammatic illustration of the ANTs longitudinal cortical thickness pipeline
for a single subject with $N$ time points.  From the $N$ original T1-weighted
images (left column, yellow panel) and the group template and priors (bottom row,
green panel), the single-single subject template (SST) and auxiliary prior images
are created (center, blue panel).  These subject-specific template and other
auxiliary images are used to
generate the individual time-point cortical thickness maps.  Optionally, one can
rigidly transform the time-point images prior to segmentation and cortical thickness
estimation (right column, red panel).  For regional thickness values, regional labels
can be propagated to each image using a given atlas set and cortical parcellation scheme.](../Figures/longitudinalPipeline.png)

Given certain practical limitations (e.g., subject recruitment and retainment),
as mentioned earlier, many researchers employ cross-sectional acquisition and
processing strategies for studying developmental phenomena.  Longitudinal
studies can significantly reduce inter-subject measurement variability.
The ANTs longitudinal cortical thickness pipeline extends the ANTs cortical
thickness pipeline for longitudinal studies which takes into account various
bias issues previously discussed in the literature
[@Yushkevich:2010aa;@Reuter:2011aa;@Reuter:2012aa].
Given $N$ time-point T1-weighted MR images and a group template and prior
probability maps (described below), the longitudinal pipeline consists of the following steps:

1. Create single-subject template (SST) and prior probability maps.
2. (Optional):  Transform each individual time point to the SST.
3. Apply the ANTs cross-sectional pipeline to each individual time-point using
SST-based priors.

An overview of these steps is provided in Figure X which we describe
in greater detail below.  One of the most significant findings presented below
is that the common step of transforming each individual
time point to the SST is suboptimal in that the corresponding interpolation
effects decrease the quality of cortical thickness measurements over
segmentation and cortical thickness estimation in native space.  

__ADNI normal group template.__  Prior to any subject processing, the group
template is generated from the population data [@Avants:2010aa] or one can use one of our publicly
available templates [@Tustison:2014ab].  For ADNI processing we created an
ADNI-specific template from 52 normal subjects.  We employed the brain extraction
method described in [@avants2010a] to create a corresponding probabilistic brain
extraction map.  We also generated six tissue prior probability
maps for the CSF, gray matter, white matter, deep gray matter, brain stem, and
cerebellum.  

![Top row:  Canonical views of the template created from 52 normal subjects
of the ADNI database.  The prior probability mask for the whole brain (middle row)
and the 6 tissue priors (bottom row) are used to "seed" each SST during longitudinal
processing.](../Figures/adniTemplate2.png)

__Single-subject template, brain mask, and tissue priors.__
Following the offline construction of the group template and prior probability images,
each subject undergoes similar processing.  First, an average shape and intensity single
subject template (SST) is created from all time point images [@Avants:2010aa].
Subsequent processing segments
the SST into six probabilistic tissues classes:   cerebrospinal
fluid (CSF), gray matter (GM), white matter (WM), deep gray matter (striatum + thalamus),
brain stem, and cerebellum.  This requires processing the SST through two parallel workflows.  First,
the SST proceeds through the standard ANTs cortical thickness pipeline which generates
a brain extraction mask and the CSF posterior probability map.  Second, using
a data set of expert annotations [@Klein:2012aa], a multi-atlas joint label
fusion step [@Wang:2013ab] is performed to create individualized probability
maps for all tissue types.  The five JLF probabilistic tissue
estimates (GM, WM, deep GM, brain stem, and cerebellum)
are used as the SST prior probabilities after smoothing with a standard
deviation = 1 mm Gaussian kernel whereas the CSF SST prior probability
is derived as a combination of the JLF and segmentation CSF estimates, i.e.,
$P(CSF) = \max\left( P_{Seg}(CSF), P_{JLF}(CSF) \right)$, also smoothed
with the same smoothing operation.  This final version of the SST enables
unbiased mappings to the group template, subject-specific tissue segmentations, region of interest volumes and
cortical thickness maps for each of the original time series images.

__Individual time point processing.__
The T1-weighted image at each
time point is rigidly aligned to the template and processed through cross-sectional cortical
thickness pipeline using the SST template and auxiliary images (brain extraction mask and
tissue priors).  

  Each
time point image is then rigidly aligned to the SST.  The SST prior probability maps are
created using a protocol combining brain extraction and a six-tissue segmentation and
a six-label joint label fusion processing of the SST.  After the SST template priors are
created, each time point image is rigidly aligned to the template to reduce the
effect of coordinate system or interpolation bias.

__Pseudo-geodesic for large cohort labeling.__  The cortical ROIs
from the DKT atlases are propogated to each time point using a "pseudo-geodesic" mapping
and joint label fusion.

## Statistical methods

We used a simple statistical principle to compare performance between
cross-sectional and longitudinal processing methods.  We said that one
method outperforms the other when it does a better job minimizing
within-subject variability and maximizing between-subject variability in
cortical thickness measurements.  Such a quality implies greater
within-subject reproducibility while distinguishing between patient
subpopulations. As such this will amount to higher precision when
cortical thickness is used as a predictor variable or model covariate in
statistical analyses upstream. This criterion is immediately assessable
in terms of estimates associated to the longitudinal
mixed-effects model outlined below.

As previously noted we observed yearly cortical thickness measurements
from sixty-two separate regions of interest.  To assess the above
variance criterion while accounting for changes that may occur through
the passage of time, we used a hierarchical Bayesian model for parameter
estimation.  Let $Y^k_{ij}$ denote the $i^{th}$ individual's cortical
thickness measurement corresponding to the $k^{th}$ region of interest
at measurement $j$.  Under the Bayesian paradigm we utilized a model of
the form \begin{gather} Y^k_{ij} \sim N(\alpha^k_i + \beta^k t,
\sigma_k^2) \\ \nonumber \alpha^k_i \sim N(\alpha^k_0, \tau^2_k) \qquad
\alpha^k_0, \beta^k \sim N(0,10)  \qquad \sigma_k^2,  \tau_k^2 \sim
\mbox{Cauchy}^+ (0, 5) \end{gather} Specification of parameters in the
above prior distributions reflect commonly accepted diffuse priors.
$\tau^2_k$ represents the between-subject variance parameter, and
$\sigma^2_k$ represents the within-subject variance parameter.  For each
region, the quantity of interest is thus the ratio $r^k =
\frac{\tau^2_k}{\sigma^2_k}$.  This ratio is closely related to the
intraclass correlation coefficient [@bartko1976various].  The posterior distribution of
$r^k$ was summarized via the posterior median. Where the posterior
distributions were obtained using Stan probabilistic programming
language [@carpenter2016stan].

For each processing method we performed sixty-two independent
regressions.  In order to compare results between methods, we considered
the quantity $\delta^k = r^k_l - r^k_c$ and $\delta^k_{norm} =
\frac{r^k_l - r^k_c}{r^k_l + r^k_c}$, denoting the variance ratio for
the longitudinal method minus that of the cross-sectional method and the
normed difference between ratios, respectively (cf Figure ??). Since a large $r^k$
implies a higher between-subject to within-subject variability ratio, a
positive estimate of $\delta^k$ that is large in magnitude implies that
the longitudinal processing method is preferable to the cross-sectional
method.  Conversely, a negative estimate that is large in magnitude
implies that the cross-sectional processing method is preferable to the
longitudinal method.


![3-D volumetric rendering of the normed difference of the longitudinal variance ratio minus
the cross-sectional variance ratio specified for each of the 62 cortical regions.](../Figures/medianRatios3D.png)

# Results


# Discussion


## Subsection 1

And a sweet equation:

$$ \exp^{-i \pi} = -1 $$



\clearpage

# References
